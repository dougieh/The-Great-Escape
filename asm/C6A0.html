<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at C6A0</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="C651.html">C651</a></span></td>
<td class="up">Up: <a href="../maps/all.html#c6a0">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="C79A.html">C79A</a></span></td>
</tr>
</table>
<div class="description">C6A0: Move characters around.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="9D7B.html">main_loop</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-1">move_characters</td>
<td class="address-2"><span id="c6a0"></span>C6A0</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-11" rowspan="2">entered_move_characters = 0xFF;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6a2"></span>C6A2</td>
<td class="instruction">LD ($A13E),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c6a5"></span>
<div class="comments">
<div class="paragraph">
Move to the next character, wrapping around after character 26.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6a5"></span>C6A5</td>
<td class="instruction">LD A,($8217)</td>
<td class="comment-11" rowspan="2">character = character_index + 1;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6a8"></span>C6A8</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6a9"></span>C6A9</td>
<td class="instruction">CP $1A</td>
<td class="comment-11" rowspan="3">if (character == character_26_STOVE_1) character = character_0_COMMANDANT;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6ab"></span>C6AB</td>
<td class="instruction">JR NZ,<a href="C6A0.html#c6ae">move_characters_0</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6ad"></span>C6AD</td>
<td class="instruction">XOR A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">move_characters_0</td>
<td class="address-2"><span id="c6ae"></span>C6AE</td>
<td class="instruction">LD ($8217),A</td>
<td class="comment-11" rowspan="1">character_index = character;</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c6b1"></span>
<div class="comments">
<div class="paragraph">
Get its chararacter struct, exiting if it's not enabled.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6b1"></span>C6B1</td>
<td class="instruction">CALL <a href="C7B9.html">get_character_struct</a></td>
<td class="comment-11" rowspan="1">HL = get_character_struct(character); // passing character in A</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6b4"></span>C6B4</td>
<td class="instruction">BIT 6,(HL)</td>
<td class="comment-11" rowspan="2">if (*HL &amp; characterstruct_FLAG_ON_SCREEN) return; /* Disabled character. */</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6b6"></span>C6B6</td>
<td class="instruction">RET NZ</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6b7"></span>C6B7</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c6b8"></span>
<div class="comments">
<div class="paragraph">
Are any items to be found in the same room as the character?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6b8"></span>C6B8</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="2">room = *++HL; // characterstruct room</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6b9"></span>C6B9</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6ba"></span>C6BA</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (room != room_0_OUTDOORS) &lt;%</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6bb"></span>C6BB</td>
<td class="instruction">JR Z,<a href="C6A0.html#c6c5">move_characters_1</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c6bd"></span>
<div class="comments">
<div class="paragraph">
This discovers one item at a time.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6bd"></span>C6BD</td>
<td class="instruction">CALL <a href="CCFB.html">is_item_discoverable_interior</a></td>
<td class="comment-11" rowspan="1">is_item_discoverable_interior(room); // passing room in A, returning item in ?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6c0"></span>C6C0</td>
<td class="instruction">JR NZ,<a href="C6A0.html#c6c5">move_characters_1</a></td>
<td class="comment-11" rowspan="2">if (Z) item_discovered(item); %&gt; // passing item in C</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6c2"></span>C6C2</td>
<td class="instruction">CALL <a href="CD31.html">item_discovered</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">move_characters_1</td>
<td class="address-2"><span id="c6c5"></span>C6C5</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">HL = characterstruct</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6c6"></span>C6C6</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="2">HL += 2; // point at characterstruct pos</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6c7"></span>C6C7</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6c8"></span>C6C8</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6c9"></span>C6C9</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="3">HL += 3; // point at characterstruct target</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6ca"></span>C6CA</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6cb"></span>C6CB</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c6cc"></span>
<div class="comments">
<div class="paragraph">
If standing still, return.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6cc"></span>C6CC</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">A = *HL; // charstr-&gt;route.index</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6cd"></span>C6CD</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (A == route_HALT) &lt;%</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6ce"></span>C6CE</td>
<td class="instruction">JR NZ,<a href="C6A0.html#c6d2">move_characters_2</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6d0"></span>C6D0</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6d1"></span>C6D1</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return; %&gt;</td>
</tr>
<tr>
<td class="asm-label-1">move_characters_2</td>
<td class="address-2"><span id="c6d2"></span>C6D2</td>
<td class="instruction">CALL <a href="C651.html">get_target</a></td>
<td class="comment-11" rowspan="1">get_target(); // "move towards" ? // returning ? in A, ? in HL</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6d5"></span>C6D5</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="2">if (A == get_target_ROUTE_ENDS) &lt;%</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6d7"></span>C6D7</td>
<td class="instruction">JP NZ,<a href="C6A0.html#c6ff">move_characters_4</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c6da"></span>
<div class="comments">
<div class="paragraph">
When the route ends reverse the route.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6da"></span>C6DA</td>
<td class="instruction">LD A,($8217)</td>
<td class="comment-11" rowspan="1">character = character_index;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6dd"></span>C6DD</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (character != character_0_COMMANDANT) &lt;%</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6de"></span>C6DE</td>
<td class="instruction">JR Z,<a href="C6A0.html#c6f2">commandant</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c6e0"></span>
<div class="comments">
<div class="paragraph">
Not the commandant.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6e0"></span>C6E0</td>
<td class="instruction">CP $0C</td>
<td class="comment-11" rowspan="2">if (character &gt;= character_12_GUARD_12) goto character_12_or_higher;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6e2"></span>C6E2</td>
<td class="instruction">JR NC,<a href="C6A0.html#c6f9">character_12_or_higher</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c6e4"></span>
<div class="comments">
<div class="paragraph">
Characters 1..11.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">character_1_to_11</td>
<td class="address-2"><span id="c6e4"></span>C6E4</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="4">*HL++ ^= (1 &lt;&lt; 7); // HLlocation-&gt;x</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6e5"></span>C6E5</td>
<td class="instruction">XOR $80</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6e7"></span>C6E7</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6e8"></span>C6E8</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c6e9"></span>
<div class="comments">
<div class="paragraph">
Pattern: [-2]+1
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6e9"></span>C6E9</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="4">if (A &amp; (1 &lt;&lt; 7)) (*HL) -= 2;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6eb"></span>C6EB</td>
<td class="instruction">JR Z,<a href="C6A0.html#c6ef">move_characters_3</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6ed"></span>C6ED</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6ee"></span>C6EE</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">move_characters_3</td>
<td class="address-2"><span id="c6ef"></span>C6EF</td>
<td class="instruction">INC (HL)</td>
<td class="comment-11" rowspan="1">(*HL)++; // i.e -1 or +1 // HLlocation-&gt;y</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6f0"></span>C6F0</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6f1"></span>C6F1</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return; %&gt;</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c6f2"></span>
<div class="comments">
<div class="paragraph">
Commandant only.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">commandant</td>
<td class="address-2"><span id="c6f2"></span>C6F2</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">A = *HL &amp; characterstruct_BYTE5_MASK; // sampled HL=$7617 (characterstruct + 5) // location</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6f3"></span>C6F3</td>
<td class="instruction">AND $7F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6f5"></span>C6F5</td>
<td class="instruction">CP $24</td>
<td class="comment-11" rowspan="2">if (A != 36) goto character_1_to_11;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6f7"></span>C6F7</td>
<td class="instruction">JR NZ,<a href="C6A0.html#c6e4">character_1_to_11</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">character_12_or_higher</td>
<td class="address-2"><span id="c6f9"></span>C6F9</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6fa"></span>C6FA</td>
<td class="instruction">JP <a href="C7C6.html">character_event</a></td>
<td class="comment-11" rowspan="1">goto character_event; // exit via</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c6fd"></span>
<div class="comments">
<div class="paragraph">
Two unused bytes.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c6fd"></span>C6FD</td>
<td class="instruction">DEFB $18,$6F</td>
<td class="comment-11" rowspan="1">%&gt;</td>
</tr>
<tr>
<td class="asm-label-1">move_characters_4</td>
<td class="address-2"><span id="c6ff"></span>C6FF</td>
<td class="instruction">CP $80</td>
<td class="comment-11" rowspan="2">if (A == 0x80) &lt;%</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c701"></span>C701</td>
<td class="instruction">JP NZ,<a href="C6A0.html#c76e">move_characters_12</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c704"></span>C704</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">// DE points at characterstruct.pos - PUSH at $C6C8</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c705"></span>C705</td>
<td class="instruction">DEC DE</td>
<td class="comment-11" rowspan="3">room = DE[-1];</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c706"></span>C706</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c707"></span>C707</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c708"></span>C708</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c709"></span>C709</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (room == room_0_OUTDOORS) &lt;%</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c70a"></span>C70A</td>
<td class="instruction">JP NZ,<a href="C6A0.html#c71f">move_characters_6</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c70d"></span>C70D</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c70e"></span>
<div class="comments">
<div class="paragraph">
Divide the location at HL by 2 and store it to saved_pos.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c70e"></span>C70E</td>
<td class="instruction">LD DE,$81A4</td>
<td class="comment-11" rowspan="1">DE = &amp;saved_pos_x;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c711"></span>C711</td>
<td class="instruction">LD B,$02</td>
<td class="comment-11" rowspan="1">B = 2; // 2 iters</td>
</tr>
<tr>
<td class="asm-label-1">move_characters_5</td>
<td class="address-2"><span id="c713"></span>C713</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="6">do &lt;% *DE++ = *HL++ &gt;&gt; 1;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c714"></span>C714</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c715"></span>C715</td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c716"></span>C716</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c717"></span>C717</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c718"></span>C718</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c719"></span>C719</td>
<td class="instruction">DJNZ <a href="C6A0.html#c713">move_characters_5</a></td>
<td class="comment-11" rowspan="1">%&gt; while (--B);</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c71b"></span>C71B</td>
<td class="instruction">LD HL,$81A4</td>
<td class="comment-11" rowspan="1">HL = &amp;saved_pos_x;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c71e"></span>C71E</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">%&gt;</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c71f"></span>
<div class="comments">
<div class="paragraph">
Establish a maximum for passing into move_towards.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">move_characters_6</td>
<td class="address-2"><span id="c71f"></span>C71F</td>
<td class="instruction">DEC DE</td>
<td class="comment-11" rowspan="7">if (DE[-1] == room_0_OUTDOORS) A = 2; else A = 6;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c720"></span>C720</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c721"></span>C721</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c722"></span>C722</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c723"></span>C723</td>
<td class="instruction">LD A,$02</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c725"></span>C725</td>
<td class="instruction">JR Z,<a href="C6A0.html#c729">move_characters_7</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c727"></span>C727</td>
<td class="instruction">LD A,$06</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">move_characters_7</td>
<td class="address-2"><span id="c729"></span>C729</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c72a"></span>C72A</td>
<td class="instruction">LD B,$00</td>
<td class="comment-11" rowspan="1">B = 0;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c72c"></span>C72C</td>
<td class="instruction">CALL <a href="C79A.html">move_towards</a></td>
<td class="comment-11" rowspan="1">move_towards(A, B, HL, DE);</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c72f"></span>C72F</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c730"></span>C730</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c731"></span>C731</td>
<td class="instruction">CALL <a href="C79A.html">move_towards</a></td>
<td class="comment-11" rowspan="1">move_towards(A, B, HL, DE);</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c734"></span>C734</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c735"></span>C735</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="3">if (B != 2) return; // managed to move</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c736"></span>C736</td>
<td class="instruction">CP $02</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c738"></span>C738</td>
<td class="instruction">RET NZ</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c739"></span>
<div class="comments">
<div class="paragraph">
So when we reach here a character is stuck.
</div>
<div class="paragraph">
Are we checking to see if a door is adjacent?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c739"></span>C739</td>
<td class="instruction">DEC DE</td>
<td class="comment-11" rowspan="2">DE -= 2; // DE -&gt; charstr-&gt;room</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c73a"></span>C73A</td>
<td class="instruction">DEC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c73b"></span>C73B</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="1">HL--; // HL -&gt; doorpos</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c73c"></span>C73C</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="5">*DE = (*HL &amp; ~door_FLAGS_MASK_DIRECTION) &gt;&gt; 2; // extract room field</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c73d"></span>C73D</td>
<td class="instruction">AND $FC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c73f"></span>C73F</td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c740"></span>C740</td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c741"></span>C741</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c742"></span>
<div class="comments">
<div class="paragraph">
Stuff reading from doors[].
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c742"></span>C742</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="4">if ((*HL &amp; door_FLAGS_MASK_DIRECTION) &lt; 2) &lt;% // sampled HL=$78FA,$794A,$78DA,$791E,$78E2,$790E,$796A,$790E,$791E,$7962,$791A</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c743"></span>C743</td>
<td class="instruction">AND $03</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c745"></span>C745</td>
<td class="instruction">CP $02</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c747"></span>C747</td>
<td class="instruction">JR NC,<a href="C6A0.html#c750">move_characters_8</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c749"></span>C749</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="5">HL += 5; %&gt; // next door's pos</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c74a"></span>C74A</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c74b"></span>C74B</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c74c"></span>C74C</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c74d"></span>C74D</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c74e"></span>C74E</td>
<td class="instruction">JR <a href="C6A0.html#c753">move_characters_9</a></td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="asm-label-1">move_characters_8</td>
<td class="address-2"><span id="c750"></span>C750</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="3">HL -= 3; %&gt; // previous door's pos</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c751"></span>C751</td>
<td class="instruction">DEC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c752"></span>C752</td>
<td class="instruction">DEC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">move_characters_9</td>
<td class="address-2"><span id="c753"></span>C753</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="2">room = *DE++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c754"></span>C754</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c755"></span>C755</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (room != room_0_OUTDOORS) &lt;%</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c756"></span>C756</td>
<td class="instruction">JR Z,<a href="C6A0.html#c761">move_characters_10</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c758"></span>
<div class="comments">
<div class="paragraph">
Indoors. Copy the door's tinypos into the charstr's tinypos.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c758"></span>C758</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++; // x</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c75a"></span>C75A</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++; // y</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c75c"></span>C75C</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++; // height</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c75e"></span>C75E</td>
<td class="instruction">DEC DE</td>
<td class="comment-11" rowspan="1">DE--; %&gt;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c75f"></span>C75F</td>
<td class="instruction">JR <a href="C6A0.html#c78b">move_characters_14</a></td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c761"></span>
<div class="comments">
<div class="paragraph">
Outdoors. Copy the door's tinypos into the charstr's tinypos, dividing by two.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">move_characters_10</td>
<td class="address-2"><span id="c761"></span>C761</td>
<td class="instruction">LD B,$03</td>
<td class="comment-11" rowspan="1">B = 3;</td>
</tr>
<tr>
<td class="asm-label-1">move_characters_11</td>
<td class="address-2"><span id="c763"></span>C763</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="6">do &lt;% *DE++ = *HL++ &gt;&gt; 1;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c764"></span>C764</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c765"></span>C765</td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c766"></span>C766</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c767"></span>C767</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c768"></span>C768</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c769"></span>C769</td>
<td class="instruction">DJNZ <a href="C6A0.html#c763">move_characters_11</a></td>
<td class="comment-11" rowspan="1">%&gt; while (--B)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c76b"></span>C76B</td>
<td class="instruction">DEC DE</td>
<td class="comment-11" rowspan="1">DE--; %&gt; %&gt;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c76c"></span>C76C</td>
<td class="instruction">JR <a href="C6A0.html#c78b">move_characters_14</a></td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="asm-label-1">move_characters_12</td>
<td class="address-2"><span id="c76e"></span>C76E</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c76f"></span>
<div class="comments">
<div class="paragraph">
Establish a maximum for passing into move_towards.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c76f"></span>C76F</td>
<td class="instruction">DEC DE</td>
<td class="comment-11" rowspan="3">room = DE[-1]; // DE -&gt; charstr</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c770"></span>C770</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c771"></span>C771</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c772"></span>C772</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="4">if (room == room_0_OUTDOORS) A = 2; else A = 6;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c773"></span>C773</td>
<td class="instruction">LD A,$02</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c775"></span>C775</td>
<td class="instruction">JR Z,<a href="C6A0.html#c779">move_characters_13</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c777"></span>C777</td>
<td class="instruction">LD A,$06</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">move_characters_13</td>
<td class="address-2"><span id="c779"></span>C779</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c77a"></span>C77A</td>
<td class="instruction">LD B,$00</td>
<td class="comment-11" rowspan="1">B = 0;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c77c"></span>C77C</td>
<td class="instruction">CALL <a href="C79A.html">move_towards</a></td>
<td class="comment-11" rowspan="1">move_towards(A, B, HL, DE);</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c77f"></span>C77F</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c780"></span>C780</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c781"></span>C781</td>
<td class="instruction">CALL <a href="C79A.html">move_towards</a></td>
<td class="comment-11" rowspan="1">move_towards(A, B, HL, DE);</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c784"></span>C784</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c785"></span>C785</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="4">if (B != 2) return; %&gt; // managed to move</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c786"></span>C786</td>
<td class="instruction">CP $02</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c788"></span>C788</td>
<td class="instruction">JR Z,<a href="C6A0.html#c78b">move_characters_14</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c78a"></span>C78A</td>
<td class="instruction">RET</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c78b"></span>
<div class="comments">
<div class="paragraph">
So when we reach here a character is stuck.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">move_characters_14</td>
<td class="address-2"><span id="c78b"></span>C78B</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++; // DE -&gt; charstr-&gt;route</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c78c"></span>C78C</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c78d"></span>C78D</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">A = *HL; // sampled HL=$761E $7625 $768E $7695 $7656 $7695 $7680 // =&gt; character struct entry + 5 // route index</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c78e"></span>C78E</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="2">if (A == route_WANDER) return;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c790"></span>C790</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c791"></span>C791</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="1">if ((A &amp; route_REVERSED) != 0) ...</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c793"></span>C793</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">HL++;       // interleaved</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="c794"></span>
<div class="comments">
<div class="paragraph">
sampled HL = $7618, $762D, $7634, $7657, $766C, $76AB, $76B2, $76B9, $76C0, $76C7 =&gt; final byte of charstruct
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c794"></span>C794</td>
<td class="instruction">JR NZ,<a href="C6A0.html#c798">move_characters_15</a></td>
<td class="comment-11" rowspan="1">... goto exit;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c796"></span>C796</td>
<td class="instruction">INC (HL)</td>
<td class="comment-11" rowspan="1">(*HL)++; // route.step</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c797"></span>C797</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return;</td>
</tr>
<tr>
<td class="asm-label-1">move_characters_15</td>
<td class="address-2"><span id="c798"></span>C798</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-11" rowspan="1">exit: (*HL)--; // route.step</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="c799"></span>C799</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return;</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="C651.html">C651</a></span></td>
<td class="up">Up: <a href="../maps/all.html#c6a0">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="C79A.html">C79A</a></span></td>
</tr>
</table>
<footer>
<div class="release">The nearly complete The Great Escape disassembly 20190312</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2019 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 7.1.</div>
</footer>
</body>
</html>