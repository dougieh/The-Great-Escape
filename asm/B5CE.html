<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at B5CE</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="B53E.html">B53E</a></span></td>
<td class="up">Up: <a href="../maps/all.html#b5ce">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="B71B.html">B71B</a></span></td>
</tr>
</table>
<div class="description">B5CE: Animate all visible characters.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="6939.html">setup_movable_items</a> and <a href="9D7B.html">main_loop</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-1">animate</td>
<td class="address-2"><span id="b5ce"></span>B5CE</td>
<td class="instruction">LD B,$08</td>
<td class="comment-11" rowspan="1">iterate over all eight vischars</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5d0"></span>B5D0</td>
<td class="instruction">LD IY,$8000</td>
<td class="comment-11" rowspan="1">set IY to first vischar</td>
</tr>
<tr>
<td class="asm-label-1">animate_0</td>
<td class="address-2"><span id="b5d4"></span>B5D4</td>
<td class="instruction">LD A,(IY+$01)</td>
<td class="comment-11" rowspan="1">get vischar.flags</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5d7"></span>B5D7</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="1">are flags set to vischar_FLAGS_EMPTY_SLOT?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5d9"></span>B5D9</td>
<td class="instruction">JP Z,<a href="B5CE.html#b6b4">animate_12</a></td>
<td class="comment-11" rowspan="1">if so - continue to next iteration</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5dc"></span>B5DC</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">stack counter</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5dd"></span>B5DD</td>
<td class="instruction">SET 7,(IY+$01)</td>
<td class="comment-11" rowspan="1">set flag vischar_FLAGS_NO_COLLIDE</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5e1"></span>B5E1</td>
<td class="instruction">BIT 7,(IY+$0D)</td>
<td class="comment-11" rowspan="1">test vischar.input &amp; input_KICK</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5e5"></span>B5E5</td>
<td class="instruction">JP NZ,<a href="B5CE.html#b6be">kicked</a></td>
<td class="comment-11" rowspan="1">if set goto 'kicked'</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5e8"></span>B5E8</td>
<td class="instruction">LD H,(IY+$0B)</td>
<td class="comment-11" rowspan="1">get vischar.anim in HL</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5eb"></span>B5EB</td>
<td class="instruction">LD L,(IY+$0A)</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5ee"></span>B5EE</td>
<td class="instruction">LD A,(IY+$0C)</td>
<td class="comment-11" rowspan="1">?anim index vischar.animindex</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5f1"></span>B5F1</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">test vischar_ANIMINDEX_BIT7  up/down flag ?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5f2"></span>B5F2</td>
<td class="instruction">JP P,<a href="B5CE.html#b64f">animate_5</a></td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5f5"></span>B5F5</td>
<td class="instruction">AND $7F</td>
<td class="comment-11" rowspan="1">mask off vischar_ANIMINDEX_BIT7</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5f7"></span>B5F7</td>
<td class="instruction">JP Z,<a href="B5CE.html#b6c2">end_bit</a></td>
<td class="comment-11" rowspan="1">if result is zero goto 'end_bit'</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5fa"></span>B5FA</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="7">anim = HL + (A + 1) * 4 - 1</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5fb"></span>B5FB</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5fc"></span>B5FC</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5fd"></span>B5FD</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b5fe"></span>B5FE</td>
<td class="instruction">LD B,$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b600"></span>B600</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b601"></span>B601</td>
<td class="instruction">DEC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b602"></span>B602</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">A = *HL; // a spriteindex_t</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b603"></span>B603</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">bank A</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b604"></span>B604</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">HL++</td>
</tr>
<tr>
<td class="asm-label-1">animate_1</td>
<td class="address-2"><span id="b605"></span>B605</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1">decrement:</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b606"></span>B606</td>
<td class="instruction">LD L,(IY+$0F)</td>
<td class="comment-11" rowspan="1">L = IY[0x0F]; // X axis</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b609"></span>B609</td>
<td class="instruction">LD H,(IY+$10)</td>
<td class="comment-11" rowspan="1">H = IY[0x10];</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b60c"></span>B60C</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">A = *DE; // sampled DE=$CF9A,$CF9E,$CFBE,$CFC2,$CFB2,$CFB6,$CFA6,$CFAA (character_related_data)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b60d"></span>B60D</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">C = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b60e"></span>B60E</td>
<td class="instruction">AND $80</td>
<td class="comment-11" rowspan="1">A &amp;= 0x80;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b610"></span>B610</td>
<td class="instruction">JR Z,<a href="B5CE.html#b614">animate_2</a></td>
<td class="comment-11" rowspan="2">if (A) A = 0xFF;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b612"></span>B612</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">animate_2</td>
<td class="address-2"><span id="b614"></span>B614</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">B = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b615"></span>B615</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-11" rowspan="1">HL -= BC;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b617"></span>B617</td>
<td class="instruction">LD ($81A4),HL</td>
<td class="comment-11" rowspan="1">saved_pos_x = HL;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b61a"></span>B61A</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b61b"></span>B61B</td>
<td class="instruction">LD L,(IY+$11)</td>
<td class="comment-11" rowspan="1">L = IY[0x11]; // Y axis</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b61e"></span>B61E</td>
<td class="instruction">LD H,(IY+$12)</td>
<td class="comment-11" rowspan="1">H = IY[0x12];</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b621"></span>B621</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">A = *DE;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b622"></span>B622</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">C = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b623"></span>B623</td>
<td class="instruction">AND $80</td>
<td class="comment-11" rowspan="1">A &amp;= 0x80;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b625"></span>B625</td>
<td class="instruction">JR Z,<a href="B5CE.html#b629">animate_3</a></td>
<td class="comment-11" rowspan="2">if (A) A = 0xFF;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b627"></span>B627</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">animate_3</td>
<td class="address-2"><span id="b629"></span>B629</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">B = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b62a"></span>B62A</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-11" rowspan="1">HL -= BC;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b62c"></span>B62C</td>
<td class="instruction">LD ($81A6),HL</td>
<td class="comment-11" rowspan="1">saved_pos_y = HL;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b62f"></span>B62F</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b630"></span>B630</td>
<td class="instruction">LD L,(IY+$13)</td>
<td class="comment-11" rowspan="1">L = IY[0x13]; // height</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b633"></span>B633</td>
<td class="instruction">LD H,(IY+$14)</td>
<td class="comment-11" rowspan="1">H = IY[0x14];</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b636"></span>B636</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">A = *DE;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b637"></span>B637</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">C = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b638"></span>B638</td>
<td class="instruction">AND $80</td>
<td class="comment-11" rowspan="1">A &amp;= 0x80;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b63a"></span>B63A</td>
<td class="instruction">JR Z,<a href="B5CE.html#b63e">animate_4</a></td>
<td class="comment-11" rowspan="2">if (A) A = 0xFF;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b63c"></span>B63C</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">animate_4</td>
<td class="address-2"><span id="b63e"></span>B63E</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">B = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b63f"></span>B63F</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-11" rowspan="1">HL -= BC;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b641"></span>B641</td>
<td class="instruction">LD ($81A8),HL</td>
<td class="comment-11" rowspan="1">saved_height = HL;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b644"></span>B644</td>
<td class="instruction">CALL <a href="AF8F.html">touch</a></td>
<td class="comment-11" rowspan="1">touch();</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b647"></span>B647</td>
<td class="instruction">JP NZ,<a href="B5CE.html#b6a8">animate_11</a></td>
<td class="comment-11" rowspan="1">if (!Z) goto pop_next;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b64a"></span>B64A</td>
<td class="instruction">DEC (IY+$0C)</td>
<td class="comment-11" rowspan="1">IY[0x0C]--;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b64d"></span>B64D</td>
<td class="instruction">JR <a href="B5CE.html#b6a2">animate_10</a></td>
<td class="comment-11" rowspan="1">%&gt;</td>
</tr>
<tr>
<td class="asm-label-1">animate_5</td>
<td class="address-2"><span id="b64f"></span>B64F</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="2">else &lt;% if (A == *HL) goto end_bit;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b650"></span>B650</td>
<td class="instruction">JP Z,<a href="B5CE.html#b6c2">end_bit</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b653"></span>B653</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="6">HL += (A + 1) * 4;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b654"></span>B654</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b655"></span>B655</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b656"></span>B656</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b657"></span>B657</td>
<td class="instruction">LD B,$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b659"></span>B659</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">animate_6</td>
<td class="address-2"><span id="b65a"></span>B65A</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1">increment:</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b65b"></span>B65B</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">A = *DE;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b65c"></span>B65C</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1">L = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b65d"></span>B65D</td>
<td class="instruction">AND $80</td>
<td class="comment-11" rowspan="1">A &amp;= 0x80;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b65f"></span>B65F</td>
<td class="instruction">JR Z,<a href="B5CE.html#b663">animate_7</a></td>
<td class="comment-11" rowspan="2">if (A) A = 0xFF;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b661"></span>B661</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">animate_7</td>
<td class="address-2"><span id="b663"></span>B663</td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="1">H = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b664"></span>B664</td>
<td class="instruction">LD C,(IY+$0F)</td>
<td class="comment-11" rowspan="1">C = IY[0x0F]; // X axis</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b667"></span>B667</td>
<td class="instruction">LD B,(IY+$10)</td>
<td class="comment-11" rowspan="1">B = IY[0x10];</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b66a"></span>B66A</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-11" rowspan="1">HL += BC;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b66b"></span>B66B</td>
<td class="instruction">LD ($81A4),HL</td>
<td class="comment-11" rowspan="1">saved_pos_x = HL;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b66e"></span>B66E</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b66f"></span>B66F</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">A = *DE;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b670"></span>B670</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1">L = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b671"></span>B671</td>
<td class="instruction">AND $80</td>
<td class="comment-11" rowspan="1">A &amp;= 0x80;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b673"></span>B673</td>
<td class="instruction">JR Z,<a href="B5CE.html#b677">animate_8</a></td>
<td class="comment-11" rowspan="2">if (A) A = 0xFF;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b675"></span>B675</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">animate_8</td>
<td class="address-2"><span id="b677"></span>B677</td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="1">H = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b678"></span>B678</td>
<td class="instruction">LD C,(IY+$11)</td>
<td class="comment-11" rowspan="1">C = IY[0x11]; // Y axis</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b67b"></span>B67B</td>
<td class="instruction">LD B,(IY+$12)</td>
<td class="comment-11" rowspan="1">B = IY[0x12];</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b67e"></span>B67E</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-11" rowspan="1">HL += BC;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b67f"></span>B67F</td>
<td class="instruction">LD ($81A6),HL</td>
<td class="comment-11" rowspan="1">saved_pos_y = HL;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b682"></span>B682</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b683"></span>B683</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">A = *DE;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b684"></span>B684</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1">L = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b685"></span>B685</td>
<td class="instruction">AND $80</td>
<td class="comment-11" rowspan="1">A &amp;= 0x80;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b687"></span>B687</td>
<td class="instruction">JR Z,<a href="B5CE.html#b68b">animate_9</a></td>
<td class="comment-11" rowspan="2">if (A) A = 0xFF;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b689"></span>B689</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">animate_9</td>
<td class="address-2"><span id="b68b"></span>B68B</td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="1">H = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b68c"></span>B68C</td>
<td class="instruction">LD C,(IY+$13)</td>
<td class="comment-11" rowspan="1">C = IY[0x13]; // height</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b68f"></span>B68F</td>
<td class="instruction">LD B,(IY+$14)</td>
<td class="comment-11" rowspan="1">B = IY[0x14];</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b692"></span>B692</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-11" rowspan="1">HL += BC;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b693"></span>B693</td>
<td class="instruction">LD ($81A8),HL</td>
<td class="comment-11" rowspan="1">saved_height = HL;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b696"></span>B696</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b697"></span>B697</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">A = *DE; // sprite_index</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b698"></span>B698</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b699"></span>B699</td>
<td class="instruction">CALL <a href="AF8F.html">touch</a></td>
<td class="comment-11" rowspan="1">touch();</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b69c"></span>B69C</td>
<td class="instruction">JP NZ,<a href="B5CE.html#b6a8">animate_11</a></td>
<td class="comment-11" rowspan="1">if (!Z) goto pop_next;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b69f"></span>B69F</td>
<td class="instruction">INC (IY+$0C)</td>
<td class="comment-11" rowspan="1">IY[0x0C]++; %&gt;</td>
</tr>
<tr>
<td class="asm-label-1">animate_10</td>
<td class="address-2"><span id="b6a2"></span>B6A2</td>
<td class="instruction">PUSH IY</td>
<td class="comment-11" rowspan="2">HL = IY;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6a4"></span>B6A4</td>
<td class="instruction">POP HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6a5"></span>B6A5</td>
<td class="instruction">CALL <a href="B729.html">calc_vischar_iso_pos_from_state</a></td>
<td class="comment-11" rowspan="1">calc_vischar_iso_pos_from_state();</td>
</tr>
<tr>
<td class="asm-label-1">animate_11</td>
<td class="address-2"><span id="b6a8"></span>B6A8</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">pop_next:</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6a9"></span>B6A9</td>
<td class="instruction">LD A,(IY+$01)</td>
<td class="comment-11" rowspan="4">if (IY[1] != vischar_FLAGS_EMPTY_SLOT) IY[1] &amp;= ~vischar_FLAGS_NO_COLLIDE; // $8001</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6ac"></span>B6AC</td>
<td class="instruction">CP $FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6ae"></span>B6AE</td>
<td class="instruction">JR Z,<a href="B5CE.html#b6b4">animate_12</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6b0"></span>B6B0</td>
<td class="instruction">RES 7,(IY+$01)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">animate_12</td>
<td class="address-2"><span id="b6b4"></span>B6B4</td>
<td class="instruction">LD DE,$0020</td>
<td class="comment-11" rowspan="1">next: DE = 32; // stride</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6b7"></span>B6B7</td>
<td class="instruction">ADD IY,DE</td>
<td class="comment-11" rowspan="1">IY += DE;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6b9"></span>B6B9</td>
<td class="instruction">DEC B</td>
<td class="comment-11" rowspan="2">%&gt; while (--B);</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6ba"></span>B6BA</td>
<td class="instruction">JP NZ,<a href="B5CE.html#b5d4">animate_0</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6bd"></span>B6BD</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return;</td>
</tr>
<tr>
<td class="asm-label-1">kicked</td>
<td class="address-2"><span id="b6be"></span>B6BE</td>
<td class="instruction">RES 7,(IY+$0D)</td>
<td class="comment-11" rowspan="1">reset input_KICK flag</td>
</tr>
<tr>
<td class="asm-label-1">end_bit</td>
<td class="address-2"><span id="b6c2"></span>B6C2</td>
<td class="instruction">LD A,(IY+$0E)</td>
<td class="comment-11" rowspan="1">get vischar.direction</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6c5"></span>B6C5</td>
<td class="instruction">LD D,A</td>
<td class="comment-11" rowspan="5">multiply it by 9</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6c6"></span>B6C6</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6c7"></span>B6C7</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6c8"></span>B6C8</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6c9"></span>B6C9</td>
<td class="instruction">ADD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6ca"></span>B6CA</td>
<td class="instruction">ADD A,(IY+$0D)</td>
<td class="comment-11" rowspan="1">add vischar.input to it</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6cd"></span>B6CD</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6ce"></span>B6CE</td>
<td class="instruction">LD D,$00</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6d0"></span>B6D0</td>
<td class="instruction">LD HL,$CDAA</td>
<td class="comment-11" rowspan="1">add it to animindices</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6d3"></span>B6D3</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6d4"></span>B6D4</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">fetch the (table entry)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6d5"></span>B6D5</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6d6"></span>B6D6</td>
<td class="instruction">LD L,(IY+$08)</td>
<td class="comment-11" rowspan="1">HL = vischar.animbase</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6d9"></span>B6D9</td>
<td class="instruction">LD H,(IY+$09)</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6dc"></span>B6DC</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">double A (and in doing so discard the top bit!)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6dd"></span>B6DD</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6de"></span>B6DE</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-11" rowspan="1">(D is still zero from above)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6df"></span>B6DF</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="5">vischar.anim = *HL</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6e0"></span>B6E0</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6e1"></span>B6E1</td>
<td class="instruction">LD (IY+$0A),E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6e4"></span>B6E4</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6e5"></span>B6E5</td>
<td class="instruction">LD (IY+$0B),D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6e8"></span>B6E8</td>
<td class="instruction">BIT 7,C</td>
<td class="comment-11" rowspan="2">if ((C &amp; (1&lt;&lt;7)) == 0) &lt;%</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6ea"></span>B6EA</td>
<td class="instruction">JR NZ,<a href="B5CE.html#b6fc">animate_13</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6ec"></span>B6EC</td>
<td class="instruction">LD (IY+$0C),$00</td>
<td class="comment-11" rowspan="1">vischar.animindex = 0</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6f0"></span>B6F0</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="2">DE += 2;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6f1"></span>B6F1</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6f2"></span>B6F2</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="2">vischar.direction = *DE;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6f3"></span>B6F3</td>
<td class="instruction">LD (IY+$0E),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6f6"></span>B6F6</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="2">DE += 2; // point to groups of four</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6f7"></span>B6F7</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6f8"></span>B6F8</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6f9"></span>B6F9</td>
<td class="instruction">JP <a href="B5CE.html#b65a">animate_6</a></td>
<td class="comment-11" rowspan="1">goto increment</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b6fc"></span>
<div class="comments">
<div class="paragraph">
else
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">animate_13</td>
<td class="address-2"><span id="b6fc"></span>B6FC</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">A = *DE; // count of four-byte groups</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6fd"></span>B6FD</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">C = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b6fe"></span>B6FE</td>
<td class="instruction">OR $80</td>
<td class="comment-11" rowspan="2">vischar.animindex = A | vischar_ANIMINDEX_BIT7;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b700"></span>B700</td>
<td class="instruction">LD (IY+$0C),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b703"></span>B703</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="3">vischar.direction = *++DE;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b704"></span>B704</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b705"></span>B705</td>
<td class="instruction">LD (IY+$0E),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b708"></span>B708</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="3">DE += 3; // point to groups of four</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b709"></span>B709</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b70a"></span>B70A</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b70b"></span>B70B</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b70c"></span>B70C</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b70d"></span>B70D</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="7">HL += C * 4 - 1;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b70e"></span>B70E</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b70f"></span>B70F</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b710"></span>B710</td>
<td class="instruction">DEC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b711"></span>B711</td>
<td class="instruction">LD B,$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b713"></span>B713</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b714"></span>B714</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b715"></span>B715</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">A = *HL;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b716"></span>B716</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b717"></span>B717</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b718"></span>B718</td>
<td class="instruction">JP <a href="B5CE.html#b605">animate_1</a></td>
<td class="comment-11" rowspan="1">goto decrement</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="B53E.html">B53E</a></span></td>
<td class="up">Up: <a href="../maps/all.html#b5ce">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="B71B.html">B71B</a></span></td>
</tr>
</table>
<footer>
<div class="release">The nearly complete The Great Escape disassembly 20180825</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2018 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 6.4.</div>
</footer>
</body>
</html>