<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at B916</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="B89C.html">B89C</a></span></td>
<td class="up">Up: <a href="../maps/all.html#b916">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="BACD.html">BACD</a></span></td>
</tr>
</table>
<div class="description">B916: Render the mask buffer.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="B866.html">B866</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b916"></span>
<div class="comments">
<div class="paragraph">
Clear the mask buffer.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="b916"></span>B916</td>
<td class="instruction">LD HL,$8100</td>
<td class="comment-11" rowspan="5">memset(mask_buffer, 0xFF, 0xA0);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b919"></span>B919</td>
<td class="instruction">LD (HL),$FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b91b"></span>B91B</td>
<td class="instruction">LD DE,$8101</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b91e"></span>B91E</td>
<td class="instruction">LD BC,$009F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b921"></span>B921</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b923"></span>B923</td>
<td class="instruction">LD A,($68A0)</td>
<td class="comment-11" rowspan="3">if (room_index) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b926"></span>B926</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b927"></span>B927</td>
<td class="instruction">JR Z,$B935</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b929"></span>
<div class="comments">
<div class="paragraph">
Indoors.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b929"></span>B929</td>
<td class="instruction">LD HL,$81DA</td>
<td class="comment-11" rowspan="1">HL = &amp;interior_mask_data;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b92c"></span>B92C</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">A = *HL; // count byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b92d"></span>B92D</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (A == 0) return; // no masks</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b92e"></span>B92E</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b92f"></span>B92F</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">B = A; // iterations</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b930"></span>B930</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="4">HL += 3; %&gt; // skip count byte, then off by 2 bytes</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b931"></span>B931</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b932"></span>B932</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b933"></span>B933</td>
<td class="instruction">JR $B93A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b935"></span>
<div class="comments">
<div class="paragraph">
Outdoors. Bug? This count of 59 doesn't match NELEMS(exterior_mask_data); which is 58.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="b935"></span>B935</td>
<td class="instruction">LD B,$3B</td>
<td class="comment-11" rowspan="1">else &lt;% B = 59; // 59 iterations</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b937"></span>B937</td>
<td class="instruction">LD HL,$EC03</td>
<td class="comment-11" rowspan="1">HL = $EC03; // exterior_mask_data + 2 bytes %&gt;</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b93a"></span>
<div class="comments">
<div class="paragraph">
Mask against all.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="b93a"></span>B93A</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">do &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b93b"></span>B93B</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b93c"></span>B93C</td>
<td class="instruction">LD A,($81B5)</td>
<td class="comment-11" rowspan="2">A = screenpos_x - 1;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b93f"></span>B93F</td>
<td class="instruction">DEC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b940"></span>B940</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="6">if (A &gt;= HL[0] || A + 4 &lt; HL[-1]) goto pop_next;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b941"></span>B941</td>
<td class="instruction">JP NC,$BAC3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b944"></span>B944</td>
<td class="instruction">ADD A,$04</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b946"></span>B946</td>
<td class="instruction">DEC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b947"></span>B947</td>
<td class="instruction">CP (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b948"></span>B948</td>
<td class="instruction">JP C,$BAC3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b94b"></span>B94B</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="3"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b94c"></span>B94C</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b94d"></span>B94D</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b94e"></span>B94E</td>
<td class="instruction">LD A,($81B6)</td>
<td class="comment-11" rowspan="2">A = screenpos_y - 1;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b951"></span>B951</td>
<td class="instruction">DEC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b952"></span>B952</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="6">if (A &gt;= HL[2] || A + 5 &lt; HL[1]) goto pop_next;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b953"></span>B953</td>
<td class="instruction">JP NC,$BAC3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b956"></span>B956</td>
<td class="instruction">ADD A,$05</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b958"></span>B958</td>
<td class="instruction">DEC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b959"></span>B959</td>
<td class="instruction">CP (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b95a"></span>B95A</td>
<td class="instruction">JP C,$BAC3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b95d"></span>B95D</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="2"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b95e"></span>B95E</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b95f"></span>B95F</td>
<td class="instruction">LD A,($81B2)</td>
<td class="comment-11" rowspan="5">if (tinypos_stash_x &lt;= HL[3]) goto pop_next;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b962"></span>B962</td>
<td class="instruction">CP (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b963"></span>B963</td>
<td class="instruction">JP Z,$BAC3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b966"></span>B966</td>
<td class="instruction">JP C,$BAC3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b969"></span>B969</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b96a"></span>B96A</td>
<td class="instruction">LD A,($81B3)</td>
<td class="comment-11" rowspan="4">if (tinypos_stash_y &lt; HL[4]) goto pop_next;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b96d"></span>B96D</td>
<td class="instruction">CP (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b96e"></span>B96E</td>
<td class="instruction">JP C,$BAC3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b971"></span>B971</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b972"></span>B972</td>
<td class="instruction">LD A,($81B4)</td>
<td class="comment-11" rowspan="1">A = tinypos_stash_height;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b975"></span>B975</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="3">if (A) A--;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b976"></span>B976</td>
<td class="instruction">JR Z,$B979</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b978"></span>B978</td>
<td class="instruction">DEC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="b979"></span>B979</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="2">if (A &gt;= HL[5]) goto pop_next;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b97a"></span>B97A</td>
<td class="instruction">JP NC,$BAC3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b97d"></span>B97D</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="5">HL -= 6;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b97e"></span>B97E</td>
<td class="instruction">SUB $06</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b980"></span>B980</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b981"></span>B981</td>
<td class="instruction">JR NC,$B984</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b983"></span>B983</td>
<td class="instruction">DEC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b984"></span>
<div class="comments">
<div class="paragraph">
Clipping.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="b984"></span>B984</td>
<td class="instruction">LD A,($81B5)</td>
<td class="comment-11" rowspan="1">A = screenpos_x;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b987"></span>B987</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">C = A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b988"></span>B988</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="2">if (A &gt;= *HL) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b989"></span>B989</td>
<td class="instruction">JP C,$B99F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b98c"></span>B98C</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">clip_x0 = A - *HL; // sampled HL=$81EC,$81F4,$EC12</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b98d"></span>B98D</td>
<td class="instruction">LD ($B837),A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b990"></span>B990</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b991"></span>B991</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">A = *HL - C;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b992"></span>B992</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b993"></span>B993</td>
<td class="instruction">CP $03</td>
<td class="comment-11" rowspan="3">if (A &gt;= 3) A = 3;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b995"></span>B995</td>
<td class="instruction">JR C,$B999</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b997"></span>B997</td>
<td class="instruction">LD A,$03</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="b999"></span>B999</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="2">($B83A) = ++A; // clip_width + 1 %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b99a"></span>B99A</td>
<td class="instruction">LD ($B83A),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b99d"></span>B99D</td>
<td class="instruction">JR $B9B6</td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="b99f"></span>B99F</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="1">B = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9a0"></span>B9A0</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="2">clip_x0 = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9a1"></span>B9A1</td>
<td class="instruction">LD ($B837),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9a4"></span>B9A4</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="6">C = 4 - (B - C);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9a5"></span>B9A5</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9a6"></span>B9A6</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9a7"></span>B9A7</td>
<td class="instruction">LD A,$04</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9a9"></span>B9A9</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9aa"></span>B9AA</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9ab"></span>B9AB</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9ac"></span>B9AC</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="3">A = (*HL - B) + 1;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9ad"></span>B9AD</td>
<td class="instruction">SUB B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9ae"></span>B9AE</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9af"></span>B9AF</td>
<td class="instruction">CP C</td>
<td class="comment-11" rowspan="3">if (A &gt;= C) A = C;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9b0"></span>B9B0</td>
<td class="instruction">JR C,$B9B3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9b2"></span>B9B2</td>
<td class="instruction">LD A,C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="b9b3"></span>B9B3</td>
<td class="instruction">LD ($B83A),A</td>
<td class="comment-11" rowspan="1">($B83A) = A; // clip_width + 1 %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="b9b6"></span>B9B6</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9b7"></span>B9B7</td>
<td class="instruction">LD A,($81B6)</td>
<td class="comment-11" rowspan="1">A = screenpos_y;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9ba"></span>B9BA</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">C = A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9bb"></span>B9BB</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="2">if (A &gt;= *HL) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9bc"></span>B9BC</td>
<td class="instruction">JP C,$B9D2</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9bf"></span>B9BF</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">A -= *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9c0"></span>B9C0</td>
<td class="instruction">LD ($B838),A</td>
<td class="comment-11" rowspan="1">clip_y0 = A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9c3"></span>B9C3</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="3">A = *++HL - C;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9c4"></span>B9C4</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9c5"></span>B9C5</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9c6"></span>B9C6</td>
<td class="instruction">CP $04</td>
<td class="comment-11" rowspan="3">if (A &gt;= 4) A = 4;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9c8"></span>B9C8</td>
<td class="instruction">JR C,$B9CC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9ca"></span>B9CA</td>
<td class="instruction">LD A,$04</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="b9cc"></span>B9CC</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1">A++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9cd"></span>B9CD</td>
<td class="instruction">LD ($B839),A</td>
<td class="comment-11" rowspan="2">($B839) = A; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9d0"></span>B9D0</td>
<td class="instruction">JR $B9E9</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="b9d2"></span>B9D2</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="1">else &lt;% B = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9d3"></span>B9D3</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="2">clip_y0 = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9d4"></span>B9D4</td>
<td class="instruction">LD ($B838),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9d7"></span>B9D7</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="6">C = 5 - (B - C);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9d8"></span>B9D8</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9d9"></span>B9D9</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9da"></span>B9DA</td>
<td class="instruction">LD A,$05</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9dc"></span>B9DC</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9dd"></span>B9DD</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9de"></span>B9DE</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="4">A = (*++HL - B) + 1;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9df"></span>B9DF</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9e0"></span>B9E0</td>
<td class="instruction">SUB B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9e1"></span>B9E1</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9e2"></span>B9E2</td>
<td class="instruction">CP C</td>
<td class="comment-11" rowspan="3">if (A &gt;= C) A = C;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9e3"></span>B9E3</td>
<td class="instruction">JR C,$B9E6</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9e5"></span>B9E5</td>
<td class="instruction">LD A,C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="b9e6"></span>B9E6</td>
<td class="instruction">LD ($B839),A</td>
<td class="comment-11" rowspan="1">($B839) = A; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="b9e9"></span>B9E9</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="1">HL--;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9ea"></span>B9EA</td>
<td class="instruction">LD BC,$0000</td>
<td class="comment-11" rowspan="1">BC = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9ed"></span>B9ED</td>
<td class="instruction">LD A,($B838)</td>
<td class="comment-11" rowspan="7">if (clip_y0 == 0) C = -screenpos_y + *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9f0"></span>B9F0</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9f1"></span>B9F1</td>
<td class="instruction">JR NZ,$B9FA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9f3"></span>B9F3</td>
<td class="instruction">LD A,($81B6)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9f6"></span>B9F6</td>
<td class="instruction">NEG</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9f8"></span>B9F8</td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9f9"></span>B9F9</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="b9fa"></span>B9FA</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="2">HL -= 2;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9fb"></span>B9FB</td>
<td class="instruction">DEC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9fc"></span>B9FC</td>
<td class="instruction">LD A,($B837)</td>
<td class="comment-11" rowspan="7">if (clip_x0 == 0) B = -screenpos_x + *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="b9ff"></span>B9FF</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba00"></span>BA00</td>
<td class="instruction">JR NZ,$BA09</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba02"></span>BA02</td>
<td class="instruction">LD A,($81B5)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba05"></span>BA05</td>
<td class="instruction">NEG</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba07"></span>BA07</td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba08"></span>BA08</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="ba09"></span>BA09</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="1">HL--;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba0a"></span>BA0A</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">A = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba0b"></span>BA0B</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba0c"></span>BA0C</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="7">Adash = C * 32 + B;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba0d"></span>BA0D</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba0e"></span>BA0E</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba0f"></span>BA0F</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba10"></span>BA10</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba11"></span>BA11</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba12"></span>BA12</td>
<td class="instruction">ADD A,B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba13"></span>BA13</td>
<td class="instruction">LD HL,$8100</td>
<td class="comment-11" rowspan="3">HL = mask_buffer + Adash;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba16"></span>BA16</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba17"></span>BA17</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba18"></span>BA18</td>
<td class="instruction">LD ($81A0),HL</td>
<td class="comment-11" rowspan="1">($81A0) = HL; // mask buffer pointer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba1b"></span>BA1B</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba1c"></span>BA1C</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="8">DE = mask_pointers[A];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba1d"></span>BA1D</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba1e"></span>BA1E</td>
<td class="instruction">LD B,$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba20"></span>BA20</td>
<td class="instruction">LD HL,$EBC5</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba23"></span>BA23</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba24"></span>BA24</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba25"></span>BA25</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba26"></span>BA26</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba27"></span>BA27</td>
<td class="instruction">LD HL,($B839)</td>
<td class="comment-11" rowspan="1">L = clip_height; H = clip_width;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba2a"></span>BA2A</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="2">($BA70) = L; // self modify</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba2b"></span>BA2B</td>
<td class="instruction">LD ($BA70),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba2e"></span>BA2E</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="2">($BA72) = H; // self modify</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba2f"></span>BA2F</td>
<td class="instruction">LD ($BA72),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba32"></span>BA32</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="3">($BA90) = *DE - H; // self modify // *DE is the mask's width</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba33"></span>BA33</td>
<td class="instruction">SUB H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba34"></span>BA34</td>
<td class="instruction">LD ($BA90),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba37"></span>BA37</td>
<td class="instruction">LD A,$20</td>
<td class="comment-11" rowspan="3">($BABA) = 32 - H; // self modify</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba39"></span>BA39</td>
<td class="instruction">SUB H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba3a"></span>BA3A</td>
<td class="instruction">LD ($BABA),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba3d"></span>BA3D</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba3e"></span>BA3E</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="2">E = *DE;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba3f"></span>BA3F</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba40"></span>BA40</td>
<td class="instruction">LD A,($B838)</td>
<td class="comment-11" rowspan="1">A = clip_y0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba43"></span>BA43</td>
<td class="instruction">CALL <a href="BACD.html">$BACD</a></td>
<td class="comment-11" rowspan="1">HL = multiply(); D = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba46"></span>BA46</td>
<td class="instruction">LD A,($B837)</td>
<td class="comment-11" rowspan="2">E = clip_x0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba49"></span>BA49</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba4a"></span>BA4A</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-11" rowspan="1">HL += DE;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba4b"></span>BA4B</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba4c"></span>BA4C</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">HL++; // iterations</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="ba4d"></span>
<div class="comments">
<div class="paragraph">
Skip the initial clipped mask bytes.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="ba4d"></span>BA4D</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">do &lt;% A = *DE; // DE -&gt; $E560 upwards (in exterior_mask_data)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba4e"></span>BA4E</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (A &gt;= 128) &lt;% // jump if sign bit is set</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba4f"></span>BA4F</td>
<td class="instruction">JP P,$BA60</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba52"></span>BA52</td>
<td class="instruction">AND $7F</td>
<td class="comment-11" rowspan="1">A &amp;= 0x7F;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba54"></span>BA54</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba55"></span>BA55</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="2">HL -= A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba56"></span>BA56</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba58"></span>BA58</td>
<td class="instruction">JR C,$BA69</td>
<td class="comment-11" rowspan="1">if (HL &lt; 0) goto $BA69;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba5a"></span>BA5A</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++; // doesn't affect flags</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba5b"></span>BA5B</td>
<td class="instruction">JR NZ,$BA4D</td>
<td class="comment-11" rowspan="1">if (HL != 0) goto $BA4D;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba5d"></span>BA5D</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">A = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba5e"></span>BA5E</td>
<td class="instruction">JR $BA6C</td>
<td class="comment-11" rowspan="1">goto $BA6C; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="ba60"></span>BA60</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba61"></span>BA61</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="4">%&gt; while (--HL);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba62"></span>BA62</td>
<td class="instruction">LD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba63"></span>BA63</td>
<td class="instruction">OR H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba64"></span>BA64</td>
<td class="instruction">JP NZ,$BA4D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba67"></span>BA67</td>
<td class="instruction">JR $BA6C</td>
<td class="comment-11" rowspan="1">goto $BA6C;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="ba69"></span>BA69</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="2">A = -L;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba6a"></span>BA6A</td>
<td class="instruction">NEG</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="ba6c"></span>BA6C</td>
<td class="instruction">LD HL,($81A0)</td>
<td class="comment-11" rowspan="1">HL = ($81A0); // mask buffer pointer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba6f"></span>BA6F</td>
<td class="instruction">LD C,$01</td>
<td class="comment-11" rowspan="1">C = 1; // self modified</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="ba71"></span>BA71</td>
<td class="instruction">LD B,$01</td>
<td class="comment-11" rowspan="1">do &lt;% B = 1; // self modified</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="ba73"></span>BA73</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">do &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba74"></span>BA74</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Adash = *DE;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba75"></span>BA75</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Adash &amp;= Adash;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba76"></span>BA76</td>
<td class="instruction">JP P,$BA7E</td>
<td class="comment-11" rowspan="1">if (!P) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba79"></span>BA79</td>
<td class="instruction">AND $7F</td>
<td class="comment-11" rowspan="1">Adash &amp;= 0x7F;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba7b"></span>BA7B</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">// bank the counter</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba7c"></span>BA7C</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba7d"></span>BA7D</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">A = *DE; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="ba7e"></span>BA7E</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">A &amp;= A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba7f"></span>BA7F</td>
<td class="instruction">CALL NZ,<a href="BADC.html">$BADC</a></td>
<td class="comment-11" rowspan="1">if (!Z) mask_against_tile();</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba82"></span>BA82</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">L++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba83"></span>BA83</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">// unpaired?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba84"></span>BA84</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="5">if (A != 0 &amp;&amp; --A != 0) DE--;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba85"></span>BA85</td>
<td class="instruction">JR Z,$BA8B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba87"></span>BA87</td>
<td class="instruction">DEC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba88"></span>BA88</td>
<td class="instruction">JR Z,$BA8B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba8a"></span>BA8A</td>
<td class="instruction">DEC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="ba8b"></span>BA8B</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba8c"></span>BA8C</td>
<td class="instruction">DJNZ $BA73</td>
<td class="comment-11" rowspan="1">%&gt; while (--B);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba8e"></span>BA8E</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba8f"></span>BA8F</td>
<td class="instruction">LD B,$01</td>
<td class="comment-11" rowspan="1">B = 1; // self modified</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba91"></span>BA91</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">bank while we test B</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba92"></span>BA92</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="3">if (B) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba93"></span>BA93</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba94"></span>BA94</td>
<td class="instruction">JP Z,$BAB9</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba97"></span>BA97</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">unbank</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba98"></span>BA98</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (A) goto $BAA3;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba99"></span>BA99</td>
<td class="instruction">JR NZ,$BAA3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="ba9b"></span>BA9B</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">do &lt;% A = *DE;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba9c"></span>BA9C</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (A &gt;= 128) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="ba9d"></span>BA9D</td>
<td class="instruction">JP P,$BAAF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="baa0"></span>BAA0</td>
<td class="instruction">AND $7F</td>
<td class="comment-11" rowspan="1">A &amp;= 0x7F;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="baa2"></span>BAA2</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="baa3"></span>BAA3</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="4">B -= A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="baa4"></span>BAA4</td>
<td class="instruction">LD A,B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="baa5"></span>BAA5</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="baa6"></span>BAA6</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="baa7"></span>BAA7</td>
<td class="instruction">JR C,$BAB6</td>
<td class="comment-11" rowspan="1">if (B &lt; 0) goto $BAB6;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="baa9"></span>BAA9</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++; // doesn't affect flags</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="baaa"></span>BAAA</td>
<td class="instruction">JR NZ,$BA9B</td>
<td class="comment-11" rowspan="1">if (B != 0) goto $BA9B;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="baac"></span>BAAC</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">// why not just jump instr earlier? // bank</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="baad"></span>BAAD</td>
<td class="instruction">JR $BAB9</td>
<td class="comment-11" rowspan="1">goto $BAB9; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="baaf"></span>BAAF</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bab0"></span>BAB0</td>
<td class="instruction">DJNZ $BA9B</td>
<td class="comment-11" rowspan="1">%&gt; while (--B);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bab2"></span>BAB2</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">A = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bab3"></span>BAB3</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">// why not just jump instr earlier? // bank</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bab4"></span>BAB4</td>
<td class="instruction">JR $BAB9</td>
<td class="comment-11" rowspan="1">goto $BAB9;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="bab6"></span>BAB6</td>
<td class="instruction">NEG</td>
<td class="comment-11" rowspan="1">A = -A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bab8"></span>BAB8</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">// bank %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="bab9"></span>BAB9</td>
<td class="instruction">LD A,$20</td>
<td class="comment-11" rowspan="3">HL += 32; // self modified</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="babb"></span>BABB</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="babc"></span>BABC</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="babd"></span>BABD</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">// unbank</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="babe"></span>BABE</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="babf"></span>BABF</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="2">%&gt; while (--C);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bac0"></span>BAC0</td>
<td class="instruction">JP NZ,$BA71</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="bac3"></span>BAC3</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">pop_next:</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bac4"></span>BAC4</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bac5"></span>BAC5</td>
<td class="instruction">LD DE,$0008</td>
<td class="comment-11" rowspan="2">HL += 8;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bac8"></span>BAC8</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bac9"></span>BAC9</td>
<td class="instruction">DEC B</td>
<td class="comment-11" rowspan="2">%&gt; while (--B);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="baca"></span>BACA</td>
<td class="instruction">JP NZ,$B93A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">

<div class="comments">
<div class="paragraph">
Bug: RET is missing here. We fall through into multiply.
</div>
</div>
</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="B89C.html">B89C</a></span></td>
<td class="up">Up: <a href="../maps/all.html#b916">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="BACD.html">BACD</a></span></td>
</tr>
</table>
<footer>
<div class="release">The incomplete The Great Escape disassembly 20170325</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 5.4.</div>
</footer>
</body>
</html>