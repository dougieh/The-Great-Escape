<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at BAF7</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="BADC.html">BADC</a></span></td>
<td class="up">Up: <a href="../maps/all.html#baf7">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="BB98.html">BB98</a></span></td>
</tr>
</table>
<div class="description">BAF7: Clipping vischars to the game window.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="BB98.html">BB98</a> and <a href="E420.html">E420</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-1">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">0 =&gt; visible, 0xFF =&gt; invisible.</td>
</tr>
<tr>
<td class="register">BC</td>
<td class="register-desc">Clipped width.</td>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc">Clipped height.</td>
</tr>
<tr>
<td class="register">IY</td>
<td class="register-desc">Pointer to visible character.</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="baf7"></span>
<div class="comments">
<div class="paragraph">
Width part.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="baf7"></span>BAF7</td>
<td class="instruction">LD HL,$81B5</td>
<td class="comment-11" rowspan="1">HL = &amp;screenpos_x;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bafa"></span>BAFA</td>
<td class="instruction">LD A,($81BB)</td>
<td class="comment-11" rowspan="2">A = map_position[0] + 24;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bafd"></span>BAFD</td>
<td class="instruction">ADD A,$18</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="baff"></span>BAFF</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">A -= *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb00"></span>BB00</td>
<td class="instruction">JP Z,$BB94</td>
<td class="comment-11" rowspan="2">if (A &gt; 0) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb03"></span>BB03</td>
<td class="instruction">JP C,$BB94</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb06"></span>BB06</td>
<td class="instruction">CP (IY+$1E)</td>
<td class="comment-11" rowspan="1">CP IY[30]  // if (A ?? IY[30])</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb09"></span>BB09</td>
<td class="instruction">JP NC,$BB11</td>
<td class="comment-11" rowspan="1">if (carry) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb0c"></span>BB0C</td>
<td class="instruction">LD B,$00</td>
<td class="comment-11" rowspan="2">BC = A; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb0e"></span>BB0E</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb0f"></span>BB0F</td>
<td class="instruction">JR $BB33</td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="bb11"></span>BB11</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">A = *HL + IY[30];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb12"></span>BB12</td>
<td class="instruction">ADD A,(IY+$1E)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb15"></span>BB15</td>
<td class="instruction">LD HL,$81BB</td>
<td class="comment-11" rowspan="2">A -= map_position[0];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb18"></span>BB18</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb19"></span>BB19</td>
<td class="instruction">JP Z,$BB94</td>
<td class="comment-11" rowspan="2">if (A &lt;= 0) goto exit;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb1c"></span>BB1C</td>
<td class="instruction">JP C,$BB94</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb1f"></span>BB1F</td>
<td class="instruction">CP (IY+$1E)</td>
<td class="comment-11" rowspan="1">CP IY[30]</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb22"></span>BB22</td>
<td class="instruction">JP NC,$BB2E</td>
<td class="comment-11" rowspan="1">if (carry) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb25"></span>BB25</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">C = A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb26"></span>BB26</td>
<td class="instruction">NEG</td>
<td class="comment-11" rowspan="3">B = -A + IY[30]; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb28"></span>BB28</td>
<td class="instruction">ADD A,(IY+$1E)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb2b"></span>BB2B</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb2c"></span>BB2C</td>
<td class="instruction">JR $BB33</td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="bb2e"></span>BB2E</td>
<td class="instruction">LD B,$00</td>
<td class="comment-11" rowspan="2">BC = IY[30]; %&gt; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb30"></span>BB30</td>
<td class="instruction">LD C,(IY+$1E)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="bb33"></span>
<div class="comments">
<div class="paragraph">
Height part.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="bb33"></span>BB33</td>
<td class="instruction">LD A,($81BC)</td>
<td class="comment-11" rowspan="7">HL = ((map_position &gt;&gt; 8) + 17) * 8;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb36"></span>BB36</td>
<td class="instruction">ADD A,$11</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb38"></span>BB38</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb39"></span>BB39</td>
<td class="instruction">LD H,$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb3b"></span>BB3B</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb3c"></span>BB3C</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb3d"></span>BB3D</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb3e"></span>BB3E</td>
<td class="instruction">LD E,(IY+$1A)</td>
<td class="comment-11" rowspan="1">E = IY[26];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb41"></span>BB41</td>
<td class="instruction">LD D,(IY+$1B)</td>
<td class="comment-11" rowspan="1">D = IY[27];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb44"></span>BB44</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">A &amp;= A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb45"></span>BB45</td>
<td class="instruction">SBC HL,DE</td>
<td class="comment-11" rowspan="1">HL -= DE;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb47"></span>BB47</td>
<td class="instruction">JP Z,$BB94</td>
<td class="comment-11" rowspan="2">if (result &lt;= 0) goto exit;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb4a"></span>BB4A</td>
<td class="instruction">JP C,$BB94</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb4d"></span>BB4D</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="3">if (H) goto exit;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb4e"></span>BB4E</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb4f"></span>BB4F</td>
<td class="instruction">JP NZ,$BB94</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb52"></span>BB52</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="1">A = L;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb53"></span>BB53</td>
<td class="instruction">CP (IY+$1F)</td>
<td class="comment-11" rowspan="1">CP IY[31]</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb56"></span>BB56</td>
<td class="instruction">JP NC,$BB5E</td>
<td class="comment-11" rowspan="1">if (carry) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb59"></span>BB59</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="2">DE = A; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb5a"></span>BB5A</td>
<td class="instruction">LD D,$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb5c"></span>BB5C</td>
<td class="instruction">JR $BB92</td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="bb5e"></span>BB5E</td>
<td class="instruction">LD L,(IY+$1F)</td>
<td class="comment-11" rowspan="3">HL = IY[31] + DE;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb61"></span>BB61</td>
<td class="instruction">LD H,$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb63"></span>BB63</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb64"></span>BB64</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="8">DE = map_position &gt;&gt; 8 * 8;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb65"></span>BB65</td>
<td class="instruction">LD A,($81BC)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb68"></span>BB68</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb69"></span>BB69</td>
<td class="instruction">LD H,$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb6b"></span>BB6B</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb6c"></span>BB6C</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb6d"></span>BB6D</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb6e"></span>BB6E</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb6f"></span>BB6F</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">A &amp;= A; // likely: clear carry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb70"></span>BB70</td>
<td class="instruction">SBC HL,DE</td>
<td class="comment-11" rowspan="1">HL -= DE;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb72"></span>BB72</td>
<td class="instruction">JP C,$BB94</td>
<td class="comment-11" rowspan="2">if (result &lt;= 0) goto exit;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb75"></span>BB75</td>
<td class="instruction">JP Z,$BB94</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb78"></span>BB78</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="3">if (H) goto exit;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb79"></span>BB79</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb7a"></span>BB7A</td>
<td class="instruction">JP NZ,$BB94</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb7d"></span>BB7D</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="1">A = L;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb7e"></span>BB7E</td>
<td class="instruction">CP (IY+$1F)</td>
<td class="comment-11" rowspan="1">CP IY[31]</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb81"></span>BB81</td>
<td class="instruction">JP NC,$BB8D</td>
<td class="comment-11" rowspan="1">if (carry) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb84"></span>BB84</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">E = A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb85"></span>BB85</td>
<td class="instruction">NEG</td>
<td class="comment-11" rowspan="3">D = -A + IY[31]; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb87"></span>BB87</td>
<td class="instruction">ADD A,(IY+$1F)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb8a"></span>BB8A</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb8b"></span>BB8B</td>
<td class="instruction">JR $BB92</td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="bb8d"></span>BB8D</td>
<td class="instruction">LD D,$00</td>
<td class="comment-11" rowspan="2">DE = IY[31]; %&gt; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb8f"></span>BB8F</td>
<td class="instruction">LD E,(IY+$1F)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="bb92"></span>BB92</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">A = 0; // return Z (vischar is visible)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb93"></span>BB93</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="bb94"></span>BB94</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-11" rowspan="1">exit: A = 0xFF;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb96"></span>BB96</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">A &amp;= A; // return NZ (vischar is not visible)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="bb97"></span>BB97</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return;</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="BADC.html">BADC</a></span></td>
<td class="up">Up: <a href="../maps/all.html#baf7">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="BB98.html">BB98</a></span></td>
</tr>
</table>
<footer>
<div class="release">The incomplete The Great Escape disassembly 20170325</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 5.4.</div>
</footer>
</body>
</html>