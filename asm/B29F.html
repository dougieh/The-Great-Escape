<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at B29F</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="B295.html">B295</a></span></td>
<td class="up">Up: <a href="../maps/all.html#b29f">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="B2FC.html">B2FC</a></span></td>
</tr>
</table>
<div class="description">B29F: Check the character is inside of bounds, when indoors.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="B14C.html">bounds_check</a>.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IY</td>
<td class="register-desc">Pointer to visible character.</td>
</tr>
</table>
<table class="output-1">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">F</td>
<td class="register-desc">Z clear if boundary hit, set otherwise.</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label-1">interior_bounds_check</td>
<td class="address-2"><span id="b29f"></span>B29F</td>
<td class="instruction">LD A,($81BE)</td>
<td class="comment-11" rowspan="8">BC = &amp;roomdef_dimensions[roomdef_bounds_index];</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2a2"></span>B2A2</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2a3"></span>B2A3</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2a4"></span>B2A4</td>
<td class="instruction">LD BC,$6B85</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2a7"></span>B2A7</td>
<td class="instruction">ADD A,C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2a8"></span>B2A8</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2a9"></span>B2A9</td>
<td class="instruction">JR NC,<a href="B29F.html#b2ac">interior_bounds_check_0</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2ab"></span>B2AB</td>
<td class="instruction">INC B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">interior_bounds_check_0</td>
<td class="address-2"><span id="b2ac"></span>B2AC</td>
<td class="instruction">LD HL,$81A4</td>
<td class="comment-11" rowspan="1">HL = &amp;saved_pos_x;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2af"></span>B2AF</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1">A = *BC;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2b0"></span>B2B0</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="2">if (A &lt; *HL) goto stop;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2b1"></span>B2B1</td>
<td class="instruction">JR C,<a href="B29F.html#b2e7">interior_bounds_check_3</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2b3"></span>B2B3</td>
<td class="instruction">INC BC</td>
<td class="comment-11" rowspan="3">A = *++BC + 4;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2b4"></span>B2B4</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2b5"></span>B2B5</td>
<td class="instruction">ADD A,$04</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2b7"></span>B2B7</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="2">if (A &gt;= *HL) goto stop;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2b8"></span>B2B8</td>
<td class="instruction">JR NC,<a href="B29F.html#b2e7">interior_bounds_check_3</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2ba"></span>B2BA</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="2">HL += 2;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2bb"></span>B2BB</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b2bc"></span>
<div class="comments">
<div class="paragraph">
Bug: This instruction is stray code. DE is incremented but never used.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2bc"></span>B2BC</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2bd"></span>B2BD</td>
<td class="instruction">INC BC</td>
<td class="comment-11" rowspan="3">A = *++BC - 4;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2be"></span>B2BE</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2bf"></span>B2BF</td>
<td class="instruction">SUB $04</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2c1"></span>B2C1</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="2">if (A &lt; *HL) goto stop;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2c2"></span>B2C2</td>
<td class="instruction">JR C,<a href="B29F.html#b2e7">interior_bounds_check_3</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2c4"></span>B2C4</td>
<td class="instruction">INC BC</td>
<td class="comment-11" rowspan="2">A = *++BC;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2c5"></span>B2C5</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2c6"></span>B2C6</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="2">if (A &gt;= *HL) goto stop;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2c7"></span>B2C7</td>
<td class="instruction">JR NC,<a href="B29F.html#b2e7">interior_bounds_check_3</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2c9"></span>B2C9</td>
<td class="instruction">LD HL,$81BF</td>
<td class="comment-11" rowspan="1">HL = &amp;roomdef_object_bounds[0];</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2cc"></span>B2CC</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="2">B = *HL; // iterations</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2cd"></span>B2CD</td>
<td class="instruction">LD A,B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2ce"></span>B2CE</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (B == 0) return;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2cf"></span>B2CF</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2d0"></span>B2D0</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-1">interior_bounds_check_1</td>
<td class="address-2"><span id="b2d1"></span>B2D1</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">do &lt;%</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2d2"></span>B2D2</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2d3"></span>B2D3</td>
<td class="instruction">LD DE,$81A4</td>
<td class="comment-11" rowspan="1">DE = &amp;saved_pos_x;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2d6"></span>B2D6</td>
<td class="instruction">LD B,$02</td>
<td class="comment-11" rowspan="1">B = 2; // 2 iterations</td>
</tr>
<tr>
<td class="asm-label-1">interior_bounds_check_2</td>
<td class="address-2"><span id="b2d8"></span>B2D8</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">do &lt;% A = *DE;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2d9"></span>B2D9</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="5">if (A &lt; HL[0] || A &gt;= HL[1]) goto next; // next outer loop iteration</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2da"></span>B2DA</td>
<td class="instruction">JR C,<a href="B29F.html#b2f2">interior_bounds_check_4</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2dc"></span>B2DC</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2dd"></span>B2DD</td>
<td class="instruction">CP (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2de"></span>B2DE</td>
<td class="instruction">JR NC,<a href="B29F.html#b2f2">interior_bounds_check_4</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2e0"></span>B2E0</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="2">DE += 2;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2e1"></span>B2E1</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2e2"></span>B2E2</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">HL += 2; // increment moved - hope it's still correct</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2e3"></span>B2E3</td>
<td class="instruction">DJNZ <a href="B29F.html#b2d8">interior_bounds_check_2</a></td>
<td class="comment-11" rowspan="1">%&gt; while (--B);</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b2e5"></span>
<div class="comments">
<div class="paragraph">
Found.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2e5"></span>B2E5</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2e6"></span>B2E6</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">interior_bounds_check_3</td>
<td class="address-2"><span id="b2e7"></span>B2E7</td>
<td class="instruction">LD A,(IY+$07)</td>
<td class="comment-11" rowspan="3">stop: IY[7] ^= vischar_BYTE7_Y_DOMINANT; // stop character?</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2ea"></span>B2EA</td>
<td class="instruction">XOR $20</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2ec"></span>B2EC</td>
<td class="instruction">LD (IY+$07),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2ef"></span>B2EF</td>
<td class="instruction">OR $01</td>
<td class="comment-11" rowspan="1">A |= 1;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2f1"></span>B2F1</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return; // return NZ</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b2f2"></span>
<div class="comments">
<div class="paragraph">
Next iteration.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">interior_bounds_check_4</td>
<td class="address-2"><span id="b2f2"></span>B2F2</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">next:</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2f3"></span>B2F3</td>
<td class="instruction">LD DE,$0004</td>
<td class="comment-11" rowspan="2">HL += 4;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2f6"></span>B2F6</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2f7"></span>B2F7</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2f8"></span>B2F8</td>
<td class="instruction">DJNZ <a href="B29F.html#b2d1">interior_bounds_check_1</a></td>
<td class="comment-11" rowspan="1">%&gt; while (--B);</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="b2fa"></span>
<div class="comments">
<div class="paragraph">
Not found.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2fa"></span>B2FA</td>
<td class="instruction">AND B</td>
<td class="comment-11" rowspan="1">A &amp;= B; // B is zero here</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="b2fb"></span>B2FB</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return; // return Z</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="B295.html">B295</a></span></td>
<td class="up">Up: <a href="../maps/all.html#b29f">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="B2FC.html">B2FC</a></span></td>
</tr>
</table>
<footer>
<div class="release">The nearly complete The Great Escape disassembly 20180825</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2018 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 6.4.</div>
</footer>
</body>
</html>