<!DOCTYPE html>
<html>
<head>
<title>The Great Escape: Routine at E420</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="The Great Escape" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="E40F.html">E40F</a></span></td>
<td class="up">Up: <a href="../maps/all.html#e420">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="E542.html">E542</a></span></td>
</tr>
</table>
<div class="description">E420: Set up vischar plotting.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="B866.html">plot_sprites</a>.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Pointer to ? // observed: always the same as IY</td>
</tr>
<tr>
<td class="register">IY</td>
<td class="register-desc">Pointer to visible character.</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting</td>
<td class="address-2"><span id="e420"></span>E420</td>
<td class="instruction">LD A,$0F</td>
<td class="comment-11" rowspan="3">HL = &amp;vischar-&gt;mi.pos;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e422"></span>E422</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e423"></span>E423</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e424"></span>E424</td>
<td class="instruction">LD DE,$81B2</td>
<td class="comment-11" rowspan="1">DE = &amp;tinypos_stash;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e427"></span>E427</td>
<td class="instruction">LD A,($68A0)</td>
<td class="comment-11" rowspan="3">if (room_index &gt; room_0_OUTDOORS) &lt;%</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e42a"></span>E42A</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e42b"></span>E42B</td>
<td class="instruction">JR Z,<a href="E420.html#e438">setup_vischar_plotting_0</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="e42d"></span>
<div class="comments">
<div class="paragraph">
Indoors.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e42d"></span>E42D</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e42f"></span>E42F</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e430"></span>E430</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e432"></span>E432</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e433"></span>E433</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e435"></span>E435</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">HL++; %&gt;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e436"></span>E436</td>
<td class="instruction">JR <a href="E420.html#e44e">setup_vischar_plotting_2</a></td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="e438"></span>
<div class="comments">
<div class="paragraph">
Outdoors.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_0</td>
<td class="address-2"><span id="e438"></span>E438</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">A = *HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e439"></span>E439</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e43a"></span>E43A</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="1">C = *HL;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e43b"></span>E43B</td>
<td class="instruction">CALL <a href="E550.html">divide_by_8_with_rounding</a></td>
<td class="comment-11" rowspan="1">divide_by_8_with_rounding(C,A);</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e43e"></span>E43E</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">*DE++ = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e43f"></span>E43F</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e440"></span>E440</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e441"></span>E441</td>
<td class="instruction">LD B,$02</td>
<td class="comment-11" rowspan="1">B = 2; // 2 iterations</td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_1</td>
<td class="address-2"><span id="e443"></span>E443</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">do &lt;% A = *HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e444"></span>E444</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e445"></span>E445</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="1">C = *HL;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e446"></span>E446</td>
<td class="instruction">CALL <a href="E555.html">divide_by_8</a></td>
<td class="comment-11" rowspan="1">divide_by_8(C,A);</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e449"></span>E449</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">*DE++ = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e44a"></span>E44A</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e44b"></span>E44B</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e44c"></span>E44C</td>
<td class="instruction">DJNZ <a href="E420.html#e443">setup_vischar_plotting_1</a></td>
<td class="comment-11" rowspan="1">%&gt; while (--B); %&gt;</td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_2</td>
<td class="address-2"><span id="e44e"></span>E44E</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="2">C = *HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e44f"></span>E44F</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e450"></span>E450</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="1">B = *HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e451"></span>E451</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e452"></span>E452</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e453"></span>E453</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">sprite_index = *HL++; // set left/right flip flag / sprite offset</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e454"></span>E454</td>
<td class="instruction">LD ($81B7),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e457"></span>E457</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e458"></span>E458</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e459"></span>E459</td>
<td class="instruction">LD B,$02</td>
<td class="comment-11" rowspan="1">B = 2; // 2 iterations</td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_3</td>
<td class="address-2"><span id="e45b"></span>E45B</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">do &lt;% Adash = *HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e45c"></span>E45C</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e45d"></span>E45D</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="1">C = *HL++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e45e"></span>E45E</td>
<td class="instruction">CALL <a href="E555.html">divide_by_8</a></td>
<td class="comment-11" rowspan="1">divide_by_8(C,Adash);</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e461"></span>E461</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="3">*DE++ = Adash;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e462"></span>E462</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e463"></span>E463</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e464"></span>E464</td>
<td class="instruction">DJNZ <a href="E420.html#e45b">setup_vischar_plotting_3</a></td>
<td class="comment-11" rowspan="1">%&gt; while (--B);</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e466"></span>E466</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e467"></span>E467</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e468"></span>E468</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="8">DE += A * 6; // point into sprite[] array</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e469"></span>E469</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e46a"></span>E46A</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e46b"></span>E46B</td>
<td class="instruction">ADD A,C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e46c"></span>E46C</td>
<td class="instruction">ADD A,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e46d"></span>E46D</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e46e"></span>E46E</td>
<td class="instruction">JR NC,<a href="E420.html#e471">setup_vischar_plotting_4</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e470"></span>E470</td>
<td class="instruction">INC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_4</td>
<td class="address-2"><span id="e471"></span>E471</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">L += 2; // skip over room, unused bytes</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e472"></span>E472</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e473"></span>E473</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e474"></span>E474</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++; // width in bytes</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e476"></span>E476</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++; // height in rows</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e478"></span>E478</td>
<td class="instruction">LD DE,$81AC</td>
<td class="comment-11" rowspan="3">memcpy(bitmap_pointer, HL, 4); // copy bitmap pointer and mask pointer</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e47b"></span>E47B</td>
<td class="instruction">LD BC,$0004</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e47e"></span>E47E</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e480"></span>E480</td>
<td class="instruction">CALL <a href="BAF7.html">vischar_visible</a></td>
<td class="comment-11" rowspan="1">vischar_visible();</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e483"></span>E483</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (A) return; /* invisible */</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e484"></span>E484</td>
<td class="instruction">RET NZ</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e485"></span>E485</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">// PUSH clipped_width</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e486"></span>E486</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">// PUSH clipped_height</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e487"></span>E487</td>
<td class="instruction">LD A,(IY+$1E)</td>
<td class="comment-11" rowspan="1">A = IY[30]; // vischar width_bytes</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e48a"></span>E48A</td>
<td class="instruction">CP $03</td>
<td class="comment-11" rowspan="2">if (A == 3) &lt;% // 3 =&gt; 16 wide (4 =&gt; 24 wide)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e48c"></span>E48C</td>
<td class="instruction">JR NZ,<a href="E420.html#e49c">setup_vischar_plotting_5</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e48e"></span>E48E</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="2">($E2C1 + 1) = E; // self modify masked_sprite_plotter_16_wide_left</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e48f"></span>E48F</td>
<td class="instruction">LD ($E2C2),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e492"></span>E492</td>
<td class="instruction">LD ($E363),A</td>
<td class="comment-11" rowspan="1">($E362 + 1) = E; // self-modify masked_sprite_plotter_16_wide_right</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e495"></span>E495</td>
<td class="instruction">LD A,$03</td>
<td class="comment-11" rowspan="1">A = 3;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e497"></span>E497</td>
<td class="instruction">LD HL,$E0E0</td>
<td class="comment-11" rowspan="1">HL = masked_sprite_plotter_16_enables; %&gt;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e49a"></span>E49A</td>
<td class="instruction">JR <a href="E420.html#e4a8">setup_vischar_plotting_6</a></td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_5</td>
<td class="address-2"><span id="e49c"></span>E49C</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e49d"></span>E49D</td>
<td class="instruction">LD ($E121),A</td>
<td class="comment-11" rowspan="1">($E120 + 1) = E; // self-modify masked_sprite_plotter_24_wide_vischar (shift right case)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4a0"></span>E4A0</td>
<td class="instruction">LD ($E1E2),A</td>
<td class="comment-11" rowspan="1">($E1E1 + 1) = E; // self-modify masked_sprite_plotter_24_wide_vischar (shift left case)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4a3"></span>E4A3</td>
<td class="instruction">LD A,$04</td>
<td class="comment-11" rowspan="1">A = 4;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4a5"></span>E4A5</td>
<td class="instruction">LD HL,$E0EC</td>
<td class="comment-11" rowspan="1">HL = masked_sprite_plotter_24_enables; %&gt;</td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_6</td>
<td class="address-2"><span id="e4a8"></span>E4A8</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">PUSH enables</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4a9"></span>E4A9</td>
<td class="instruction">LD ($E4C0),A</td>
<td class="comment-11" rowspan="1">($E4BF + 1) = A; // self-modify</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4ac"></span>E4AC</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">E = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4ad"></span>E4AD</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1">A = B; // clipped width top byte (lefthand skip)</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4ae"></span>E4AE</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (A == 0) &lt;%</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4af"></span>E4AF</td>
<td class="instruction">JR NZ,<a href="E420.html#e4b7">setup_vischar_plotting_7</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4b1"></span>E4B1</td>
<td class="instruction">LD A,$77</td>
<td class="comment-11" rowspan="1">A = 0x77; /* opcode of 'LD (HL),A' */</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4b3"></span>E4B3</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4b4"></span>E4B4</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">Adash = C; %&gt;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4b5"></span>E4B5</td>
<td class="instruction">JR <a href="E420.html#e4bb">setup_vischar_plotting_8</a></td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_7</td>
<td class="address-2"><span id="e4b7"></span>E4B7</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">A = 0; /* opcode of 'LD (HL),A' */</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4b8"></span>E4B8</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4b9"></span>E4B9</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="2">Adash = E - C; %&gt;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4ba"></span>E4BA</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_8</td>
<td class="address-2"><span id="e4bb"></span>E4BB</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4bc"></span>E4BC</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">POP enables</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4bd"></span>E4BD</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Cdash = Adash;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4be"></span>E4BE</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="e4bf"></span>
<div class="comments">
<div class="paragraph">
Set the addresses in the jump table to NOP or LD (HL),A.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_enables_iters</td>
<td class="address-1"><span id="e4bf"></span>E4BF</td>
<td class="instruction">LD B,$03</td>
<td class="comment-11" rowspan="1">Bdash = 3; // 3 iterations // self modified by $E4A9</td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_9</td>
<td class="address-2"><span id="e4c1"></span>E4C1</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="2">do &lt;% Edash = *HLdash++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4c2"></span>E4C2</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4c3"></span>E4C3</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-11" rowspan="1">Ddash = *HLdash++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4c4"></span>E4C4</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="2">*DEdash = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4c5"></span>E4C5</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4c6"></span>E4C6</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="2">Edash = *HLdash++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4c7"></span>E4C7</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4c8"></span>E4C8</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-11" rowspan="2">Ddash = *HLdash++;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4c9"></span>E4C9</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4ca"></span>E4CA</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">*DEdash = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4cb"></span>E4CB</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="1">Cdash--;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4cc"></span>E4CC</td>
<td class="instruction">JR NZ,<a href="E420.html#e4d0">setup_vischar_plotting_10</a></td>
<td class="comment-11" rowspan="2">if (Z) A ^= 0x77; /* Toggle between LD and NOP. */</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4ce"></span>E4CE</td>
<td class="instruction">XOR $77</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_10</td>
<td class="address-2"><span id="e4d0"></span>E4D0</td>
<td class="instruction">DJNZ <a href="E420.html#e4c1">setup_vischar_plotting_9</a></td>
<td class="comment-11" rowspan="1">%&gt; while (--Bdash);</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4d2"></span>E4D2</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4d3"></span>E4D3</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1">A = D;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4d4"></span>E4D4</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">A &amp;= A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4d5"></span>E4D5</td>
<td class="instruction">LD DE,$0000</td>
<td class="comment-11" rowspan="1">DE = 0;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4d8"></span>E4D8</td>
<td class="instruction">JR NZ,<a href="E420.html#e4f5">setup_vischar_plotting_11</a></td>
<td class="comment-11" rowspan="1">if (Z) &lt;%</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4da"></span>E4DA</td>
<td class="instruction">LD A,($81BC)</td>
<td class="comment-11" rowspan="6">HL = $81BC * 8; // &amp;map_position + 1;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4dd"></span>E4DD</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4de"></span>E4DE</td>
<td class="instruction">LD H,$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4e0"></span>E4E0</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4e1"></span>E4E1</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4e2"></span>E4E2</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4e3"></span>E4E3</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4e4"></span>E4E4</td>
<td class="instruction">LD L,(IY+$1A)</td>
<td class="comment-11" rowspan="1">L = IY[26];</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4e7"></span>E4E7</td>
<td class="instruction">LD H,(IY+$1B)</td>
<td class="comment-11" rowspan="1">H = IY[27];</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4ea"></span>E4EA</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">A &amp;= A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4eb"></span>E4EB</td>
<td class="instruction">SBC HL,DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4ed"></span>E4ED</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-11" rowspan="7">HL *= 24;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4ee"></span>E4EE</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4ef"></span>E4EF</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4f0"></span>E4F0</td>
<td class="instruction">LD E,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4f1"></span>E4F1</td>
<td class="instruction">LD D,H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4f2"></span>E4F2</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4f3"></span>E4F3</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4f4"></span>E4F4</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1">%&gt;</td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_11</td>
<td class="address-2"><span id="e4f5"></span>E4F5</td>
<td class="instruction">LD A,($81B5)</td>
<td class="comment-11" rowspan="5">HL = screenpos.x - map_position.x; // subtract + extend to 16-bit</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4f8"></span>E4F8</td>
<td class="instruction">LD HL,$81BB</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4fb"></span>E4FB</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4fc"></span>E4FC</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4fd"></span>E4FD</td>
<td class="instruction">LD H,$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e4ff"></span>E4FF</td>
<td class="instruction">JR NC,<a href="E420.html#e503">setup_vischar_plotting_12</a></td>
<td class="comment-11" rowspan="2">if (HL &lt; 0) H = 0xFF; // sign extend</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e501"></span>E501</td>
<td class="instruction">LD H,$FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_12</td>
<td class="address-2"><span id="e503"></span>E503</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-11" rowspan="3">HL += DE + 0xF290; // &amp;state-&gt;window_buf[x + y];</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e504"></span>E504</td>
<td class="instruction">LD DE,$F290</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e507"></span>E507</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e508"></span>E508</td>
<td class="instruction">LD ($81A2),HL</td>
<td class="comment-11" rowspan="1">($81A2) = HL;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e50b"></span>E50B</td>
<td class="instruction">LD HL,$8100</td>
<td class="comment-11" rowspan="1">HL = mask_buffer;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e50e"></span>E50E</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e50f"></span>E50F</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e510"></span>E510</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="11">L += D * 4 + (IY[26] &amp; 7) * 4;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e511"></span>E511</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e512"></span>E512</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e513"></span>E513</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e514"></span>E514</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e515"></span>E515</td>
<td class="instruction">LD A,(IY+$1A)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e518"></span>E518</td>
<td class="instruction">AND $07</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e51a"></span>E51A</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e51b"></span>E51B</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e51c"></span>E51C</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e51d"></span>E51D</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e51e"></span>E51E</td>
<td class="instruction">LD ($81B0),HL</td>
<td class="comment-11" rowspan="1">foreground_mask_pointer = HL;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e521"></span>E521</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e522"></span>E522</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1">A = D;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e523"></span>E523</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (A) &lt;%</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e524"></span>E524</td>
<td class="instruction">JR Z,<a href="E420.html#e531">setup_vischar_plotting_14</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="e526"></span>
<div class="comments">
<div class="paragraph">
Generic multiply loop.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e526"></span>E526</td>
<td class="instruction">LD D,A</td>
<td class="comment-11" rowspan="1">D = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e527"></span>E527</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">A = 0;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e528"></span>E528</td>
<td class="instruction">LD E,(IY+$1E)</td>
<td class="comment-11" rowspan="2">E = IY[30] - 1;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e52b"></span>E52B</td>
<td class="instruction">DEC E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="e52c"></span>
<div class="comments">
<div class="paragraph">
D ends up as zero either way.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_13</td>
<td class="address-2"><span id="e52c"></span>E52C</td>
<td class="instruction">ADD A,E</td>
<td class="comment-11" rowspan="3">do &lt;% A += E; %&gt; while (--D); %&gt;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e52d"></span>E52D</td>
<td class="instruction">DEC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e52e"></span>E52E</td>
<td class="instruction">JP NZ,<a href="E420.html#e52c">setup_vischar_plotting_13</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">setup_vischar_plotting_14</td>
<td class="address-2"><span id="e531"></span>E531</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">E = A;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e532"></span>E532</td>
<td class="instruction">LD HL,($81AC)</td>
<td class="comment-11" rowspan="3">bitmap_pointer += DE;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e535"></span>E535</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e536"></span>E536</td>
<td class="instruction">LD ($81AC),HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e539"></span>E539</td>
<td class="instruction">LD HL,($81AE)</td>
<td class="comment-11" rowspan="3">mask_pointer += DE;</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e53c"></span>E53C</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e53d"></span>E53D</td>
<td class="instruction">LD ($81AE),HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e540"></span>E540</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="e541"></span>E541</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return; /* visible */</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="E40F.html">E40F</a></span></td>
<td class="up">Up: <a href="../maps/all.html#e420">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="E542.html">E542</a></span></td>
</tr>
</table>
<footer>
<div class="release">The incomplete The Great Escape disassembly 20180419</div>
<div class="copyright">&copy; 1986 Denton Designs &amp; Ocean Software Ltd. (The Great Escape). &copy; 2012-2018 David Thomas (this disassembly).</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 6.4.</div>
</footer>
</body>
</html>